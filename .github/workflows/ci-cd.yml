name: CI/CD Pipeline with Rollback

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      project_id: ${{ steps.vars.outputs.project_id }}
      region: ${{ steps.vars.outputs.region }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set variables
        id: vars
        run: |
          echo "project_id=credit2025" >> $GITHUB_ENV
          echo "region=us-central1" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pre-commit

      - name: Install pre-commit hooks
        run: pre-commit install

  lint-and-format:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: pip install flake8 black isort
      - name: Run format
        run: |
          black . || true
          isort . || true
      - name: Run lint
        run: flake8 . || true

  deploy-flask:
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Configure GCP project
        run: gcloud config set project credit2025
      - name: Build Flask Docker image
        run: make build-flask
      - name: Push Flask Docker image
        run: make push-flask
      - name: Deploy Flask with rollback on failure
        run: |
          set -e
          if ! make deploy-flask; then
            echo "Deploy failed. Rolling back Flask to previous revision..."
            REVISION=$(gcloud run revisions list fraud-api --platform managed --region us-central1 --sort-by="~createTime" --limit=2 --format="value(NAME)" | tail -n 1)
            gcloud run services update-traffic fraud-api --to-revisions=${REVISION}=100 --platform managed --region us-central1
            exit 1
          fi

  deploy-ui:
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Configure GCP project
        run: gcloud config set project credit2025
      - name: Build UI Docker image
        run: make build-ui
      - name: Push UI Docker image
        run: make push-ui
      - name: Deploy UI with rollback on failure
        run: |
          set -e
          if ! make deploy-ui; then
            echo "Deploy failed. Rolling back UI to previous revision..."
            REVISION=$(gcloud run revisions list fraud-ui --platform managed --region us-central1 --sort-by="~createTime" --limit=2 --format="value(NAME)" | tail -n 1)
            gcloud run services update-traffic fraud-ui --to-revisions=${REVISION}=100 --platform managed --region us-central1
            exit 1
          fi

  deploy-serving:
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Configure GCP project
        run: gcloud config set project credit2025
      - name: Build TF Serving Docker image
        run: make build-serving
      - name: Push TF Serving Docker image
        run: make push-serving
      - name: Deploy TF Serving with rollback on failure
        run: |
          set -e
          if ! make deploy-serving; then
            echo "Deploy failed. Rolling back TF Serving to previous revision..."
            REVISION=$(gcloud run revisions list fraud-serving --platform managed --region us-central1 --sort-by="~createTime" --limit=2 --format="value(NAME)" | tail -n 1)
            gcloud run services update-traffic fraud-serving --to-revisions=${REVISION}=100 --platform managed --region us-central1
            exit 1
          fi

  deploy-tensorboard:
    runs-on: ubuntu-latest
    needs: lint-and-format
    steps:
      - uses: actions/checkout@v4
      - name: Authenticate with GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      - name: Configure GCP project
        run: gcloud config set project credit2025
      - name: Build Tensorboard Docker image
        run: make build-tensorboard
      - name: Push Tensorboard Docker image
        run: make push-tensorboard
      - name: Deploy Tensorboard with rollback on failure
        run: |
          set -e
          if ! make deploy-tensorboard; then
            echo "Deploy failed. Rolling back Tensorboard to previous revision..."
            REVISION=$(gcloud run revisions list tensorboard --platform managed --region us-central1 --sort-by="~createTime" --limit=2 --format="value(NAME)" | tail -n 1)
            gcloud run services update-traffic tensorboard --to-revisions=${REVISION}=100 --platform managed --region us-central1
            exit 1
          fi
